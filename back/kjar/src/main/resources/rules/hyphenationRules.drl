rule "A separator cannot be between two vowels"
salience 7
when
    $sep: com.ftn.sbnz.model.models.Separator(valid == true, $pos: position)
    $left: com.ftn.sbnz.model.models.Letter(traits.type == com.ftn.sbnz.model.models.PhonemeType.VOWEL, position == $pos)
    $right: com.ftn.sbnz.model.models.Letter(traits.type == com.ftn.sbnz.model.models.PhonemeType.VOWEL, position == $pos + 1)
then
    $sep.invalidate();
    update($sep);
end

rule "A separator must have vowels on both sides"
salience 7
when
    $sep : com.ftn.sbnz.model.models.Separator(valid == true, $pos : position)
    (
        not (Letter(position > $pos, traits.type == com.ftn.sbnz.model.models.PhonemeType.VOWEL))
        or
        not (Letter(position <= $pos, traits.type == com.ftn.sbnz.model.models.PhonemeType.VOWEL))
    )
then
    $sep.invalidate();
    update($sep);
end

rule "A separator must have more than one letter to the right"
salience 7
when 
    $sep : com.ftn.sbnz.model.models.Separator(valid == true, $pos: position)
    
    $count : Number(intValue == 1) from accumulate(
        Letter(position > $pos),
        count()
    ) 
then
    $sep.invalidate();
    update($sep);
end

rule "The right-most separator with at most len letters before it is chosen for the hyphen"
salience 6
when
    $s : com.ftn.sbnz.model.models.SeparatorGenerationComplete()
    $t : com.ftn.sbnz.model.models.Text()
    $l : Integer()
    $sep : com.ftn.sbnz.model.models.Separator( !chosen, $pos : position )
    $count : Number( intValue <= $l ) from accumulate(
        $letter : com.ftn.sbnz.model.models.Letter( position <= $pos ),
        count($letter)
    )
    not(com.ftn.sbnz.model.models.Separator( position > $pos ))
then
    delete($s);
    $sep.choose();
    $t.setTemporaryWord($sep.getPosition());
    update($t);
    $t.print();
    System.out.println("Chose separator at position " + $sep.getPosition());
    update($sep);
end

rule "Mark separators generation complete"
salience 0
when
    $nucleiList : java.util.List() from collect(
        com.ftn.sbnz.model.models.Letter(traits.type == com.ftn.sbnz.model.models.PhonemeType.VOWEL)
    )
    
    $sepCount : Number() from accumulate(
        com.ftn.sbnz.model.models.Separator(),
        count(1)
    )
    
    eval($sepCount.intValue() == $nucleiList.size() - 1)
then
    System.out.println("NUCLEI LIST " + $nucleiList.size());
    for (Object obj : $nucleiList) {
        com.ftn.sbnz.model.models.Letter l = (com.ftn.sbnz.model.models.Letter) obj;
        System.out.println(l);
    }
    insert(new com.ftn.sbnz.model.models.SeparatorGenerationComplete());
end

rule "Clear all separators if a separator has been chosen"
salience 5
when
    $chosen : com.ftn.sbnz.model.models.Separator(chosen, $pos : position)
    $otherSep : com.ftn.sbnz.model.models.Separator(position != $pos)
then
    System.out.println("Cleanup: separator at pos " + $otherSep.getPosition());
    delete($otherSep);
end

rule "Clear all letters before chosen separator"
salience 5
when
    $chosen : com.ftn.sbnz.model.models.Separator(chosen == true, $pos : position)
    $letter : com.ftn.sbnz.model.models.Letter(position <= $pos)
then
    System.out.println("Cleanup: letter at pos " + $letter.getPosition());
    delete($letter);
end

rule "Delete chosen separator"
salience 4
when
    $sep : com.ftn.sbnz.model.models.Separator(chosen == true)
then
    delete($sep);
    System.out.println("Deleted chosen separator");
end